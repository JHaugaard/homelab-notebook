# Session Context - Homelab Notebook

**Last Updated:** 2025-12-08
**Session Purpose:** Security Audit Deployment Fixes - COMPLETE

---

## Current Session Summary

### Post-Deployment Fixes (2025-12-08)

After deploying the security audit fixes, discovered issues with the production app not loading data. Root cause: SvelteKit `$env/static/public` variables are baked in at **build time**, not runtime.

#### Issues Fixed

| Issue | Cause | Fix |
|-------|-------|-----|
| CI build failing | Missing `PUBLIC_POCKETBASE_PUBLIC_URL` env var | Added to `.github/workflows/ci.yml` |
| App showing "No entries" in production | Dockerfile missing build-time env var | Added `PUBLIC_POCKETBASE_PUBLIC_URL` to Dockerfile |
| CSP blocking font | Security headers too restrictive | (Minor - noted for future fix) |

#### Files Modified This Session
- `.github/workflows/ci.yml` - Added `PUBLIC_POCKETBASE_PUBLIC_URL` env var
- `Dockerfile` - Added `PUBLIC_POCKETBASE_PUBLIC_URL` as build-time ARG/ENV

#### Key Learning
SvelteKit's `$env/static/public` imports are resolved at **build time**. Runtime environment variables (like Fly.io secrets) don't override them. The Dockerfile must include all PUBLIC_ vars as build args.

---

## Previous Session Summary (2025-12-07)

### Security Audit Results
Conducted comprehensive security audit using Zen MCP `secaudit` tool. Identified and remediated **9 vulnerabilities**.

### Vulnerabilities Fixed

| # | Severity | Issue | Fix |
|---|----------|-------|-----|
| 1 | HIGH | XSS via unsanitized markdown | Added DOMPurify in `src/lib/utils/markdown.ts` |
| 2 | MEDIUM | httpOnly:false on auth cookie | Changed to `httpOnly: true` in hooks.server.ts |
| 3 | MEDIUM | Missing security headers | Added CSP, X-Frame-Options, etc. in hooks.server.ts |
| 4 | MEDIUM | PocketBase filter injection | Added input validation/escaping in pocketbase.ts |
| 5 | MEDIUM | IDOR in file deletion | Added ownership verification in delete endpoint |
| 6 | MEDIUM | IDOR in upload URL | Added ownership verification in upload endpoint |
| 7 | LOW | cookie package vulnerability | Added pnpm override for cookie>=0.7.0 |
| 8 | LOW | Debug logging in production | Removed presigned URL logging from tigris.ts |
| 9 | LOW | Hardcoded PocketBase URL | Moved to PUBLIC_POCKETBASE_PUBLIC_URL env var |

### Files Modified
- `src/lib/utils/markdown.ts` (new) - DOMPurify sanitization
- `src/lib/utils/index.ts` - Export markdown utility
- `src/routes/reference/[id]/+page.svelte` - Use shared renderMarkdown
- `src/routes/research/[id]/+page.svelte` - Use shared renderMarkdown
- `src/routes/project/[id]/+page.svelte` - Use shared renderMarkdown
- `src/hooks.server.ts` - httpOnly cookies + security headers
- `src/routes/login/+page.svelte` - Server action form
- `src/routes/login/+page.server.ts` (new) - Server-side auth
- `src/lib/services/pocketbase.ts` - Filter injection prevention
- `src/routes/api/attachments/delete/+server.ts` - Ownership check
- `src/routes/api/attachments/upload-url/+server.ts` - Ownership check
- `src/lib/components/ui/AttachmentDropZone.svelte` - Pass entryId
- `src/routes/*/[id]/edit/+page.svelte` (3 files) - Pass entryId to delete
- `src/lib/server/tigris.ts` - Remove debug logging
- `.env.example` - Document new env var
- `.env.local` - Add PUBLIC_POCKETBASE_PUBLIC_URL
- `package.json` - pnpm override for cookie

### New Dependencies
- `dompurify` - HTML sanitization for markdown

### Fly.io Deployment
Secret added:
```bash
fly secrets set PUBLIC_POCKETBASE_PUBLIC_URL="https://proposaltracker-api.fly.dev"
fly deploy
```

---

## Previous Session Summary (2025-12-07)

### Tigris Storage Integration - COMPLETE
- Presigned URL uploads working
- JSON metadata in PocketBase, files in Tigris S3
- Fixed credential mismatch issue
- All upload/download functionality verified

---

## Configuration

### Production (Fly.io)
- **App URL:** https://homelab-notebook.fly.dev
- **Custom Domain:** https://homelab-notebook.haugaard.app
- **PocketBase API (internal):** http://proposaltracker-api.internal:8080
- **PocketBase API (public):** https://proposaltracker-api.fly.dev
- **PocketBase Admin:** https://proposaltracker-api.fly.dev/_/

### Environment Variables (Production)
- `PUBLIC_POCKETBASE_URL` - Internal PocketBase URL for server-side
- `PUBLIC_POCKETBASE_PUBLIC_URL` - Public PocketBase URL for browser
- `AWS_*` / `BUCKET_NAME` - Tigris S3 credentials

### Security Headers (Production)
- Content-Security-Policy (CSP)
- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- Referrer-Policy: strict-origin-when-cross-origin
- Permissions-Policy (camera, mic, geo disabled)

---

## Quick Commands

```bash
pnpm dev          # Local development
pnpm build        # Production build
pnpm check        # TypeScript/Svelte check
pnpm lint         # ESLint
fly logs          # View Fly.io logs
fly secrets list  # View secrets
fly deploy        # Deploy to production
```

---

## Session Status

**Completed:** 2025-12-08 ~02:30 UTC
**MCP Servers cleaned:** Zen (disabled)
**Tool count:** 6 (clean slate)
